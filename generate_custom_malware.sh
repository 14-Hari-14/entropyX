#!/bin/bash
mkdir -p data/malicious

# We remove the old "boring" files if they exist to keep the dataset clean
rm data/malicious/plain_*.exe 2>/dev/null
rm data/malicious/xor_*.exe 2>/dev/null

echo "[*] Generating 300 Custom High-Entropy Loaders..."

for i in {1..300}; do
    # 1. Random Payload Size (10KB to 100KB)
    #    Real malware varies in size. We simulate this.
    PAYLOAD_SIZE=$((10000 + RANDOM % 90000))
    
    # 2. Generate Random Hex Data (Simulates the encrypted payload)
    #    This creates the "Plateau" on your entropy graph.
    PAYLOAD_DATA=$(head /dev/urandom | tr -dc A-F0-9 | head -c $PAYLOAD_SIZE)
    
    # 3. Write the C Source
    cat <<EOF > "loader_$i.c"
#include <stdio.h>
#include <windows.h>

// This huge array mimics the "attached payload" from your StackOverflow code.
// Ideally, this pushes the file entropy up significantly.
const char encrypted_payload[] = "$PAYLOAD_DATA";

int main() {
    // We add some fake logic so the .text section isn't empty
    printf("Stub #$i loaded. Payload Size: %d\n", sizeof(encrypted_payload));
    
    // Fake decryption loop (Simulating work)
    int check = 0;
    for(int i = 0; i < 100; i++) {
        check += (int)encrypted_payload[i];
    }
    
    Sleep(50); 
    return 0;
}
EOF

    # 4. Compile (Strip symbols with -s to make it look like release malware)
    x86_64-w64-mingw32-gcc "loader_$i.c" -o "data/malicious/custom_loader_$i.exe" -s 2>/dev/null
    
    rm "loader_$i.c"
    
    # Progress Bar
    if (( $i % 50 == 0 )); then echo -n "."; fi
done

echo ""
echo "[+] Done! 'Custom Loaders' have replaced the weak msfvenom files."