#!/bin/bash
mkdir -p data/malicious/custom_malware_bash
echo "[*] Generating 300 High-Entropy (Raw Binary) Loaders..."

for i in {1..300}; do
    # 1. Generate 20KB - 50KB of data
    PAYLOAD_SIZE=$((20000 + RANDOM % 30000))
    
    # 2. CRITICAL FIX: Generate a C-style byte array (e.g., 0xAB, 0x12, ...)
    #    We use 'od' (octal dump) to convert raw random bytes into hex format
    PAYLOAD_ARRAY=$(head -c $PAYLOAD_SIZE /dev/urandom | od -An -v -t x1 | sed 's/ / 0x/g' | tr -d '\n' | sed 's/^ 0x/0x/' | sed 's/ 0x/, 0x/g')

    # 3. Create the C Source
    cat <<EOF > "loader_$i.c"
#include <stdio.h>
#include <windows.h>

// Now this is a RAW BYTE array, not a string.
// This will force the compiled section to have ~7.99 entropy.
unsigned char encrypted_payload[] = { $PAYLOAD_ARRAY };

int main() {
    printf("Stub #$i loaded. Payload Size: %d\n", sizeof(encrypted_payload));
    
    // Fake decryption to ensure the array is used (so compiler doesn't optimize it out)
    int check = 0;
    for(int i = 0; i < 100; i++) {
        check += (int)encrypted_payload[i];
    }
    Sleep(50); 
    return 0;
}
EOF

    # 4. Compile (-s strips symbols to make it smaller/denser)
    x86_64-w64-mingw32-gcc "loader_$i.c" -o "data/malicious/custom_malware_bash/custom_loader_$i.exe" -s 2>/dev/null
    rm "loader_$i.c"
    
    if (( $i % 10 == 0 )); then echo -n "."; fi
done
echo " Done!"