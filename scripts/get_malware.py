import os, time, io, zipfile, requests, pyzipper
from dotenv import load_dotenv

load_dotenv()

# --- CONFIG ---
API_KEY =   os.environ.get("MALWARE_BAZAAR_API_KEY")
BASE_DIR = "data1/malicious/authentic/akira"
TARGET_TOTAL = 600
FAMILIES = [
    "Akira",          # Very active, Conti successor, high victim count
    "Qilin",          # Often top-listed in recent reports
    "Play",           # Consistent activity
    "Medusa",         # Strong in critical sectors
    "RansomHub",      # Major player post-2024 disruptions
    "LockBit",        # Use this single version (capital B); relaunched
    "Clop",           # Or "Cl0p" if needed, but "Clop" is common
    "BlackBasta",     # Still impactful
    "Lynx",           # Rising
    "DragonForce"     # Emerging alliances
]

def download_dataset():
    headers = {'Auth-Key': API_KEY.strip()}
    total_downloaded = 0
    os.makedirs(BASE_DIR, exist_ok=True)
    for tag in FAMILIES:
        if total_downloaded >= TARGET_TOTAL: break
        family_dir = os.path.join(BASE_DIR, tag)
        os.makedirs(family_dir, exist_ok=True)
        print(f"\n[*] SEARCHING: {tag}")
        # 1. Broad Search: Try 'get_taginfo' first
        payload = {'query': 'get_taginfo', 'tag': tag, 'limit': 50}
        res = requests.post("https://mb-api.abuse.ch/api/v1/", data=payload, headers=headers)
        try:
            data = res.json()
            if data.get('query_status') != 'ok':
                print(f" [!] Tag Search Error: {data.get('query_status')}")
                samples = []
            else:
                samples = data.get('data', [])
        except Exception as e:
            print(f" [!] JSON Error: {e}")
            samples = []

        # If tag search fails, try signature search
        if not samples:
            print(f" [!] No Tags found for '{tag}', trying Signature search...")
            payload = {'query': 'get_siginfo', 'signature': tag, 'limit': 50}
            res = requests.post("https://mb-api.abuse.ch/api/v1/", data=payload, headers=headers)
            try:
                data = res.json()
                if data.get('query_status') != 'ok':
                    print(f" [!] Signature Search Error: {data.get('query_status')}")
                    samples = []
                else:
                    samples = data.get('data', [])
            except Exception as e:
                print(f" [!] JSON Error: {e}")
                samples = []

        print(f" [+] Found {len(samples)} potential samples.")
        # 2. Download loop
        for sample in samples:
            if total_downloaded >= TARGET_TOTAL: break
            sha256 = sample['sha256_hash']
            f_type = sample.get('file_type', 'unknown')
            # LOGGING: See why files are being skipped
            if f_type not in ['exe', 'dll']:  # Add 'elf' if needed
                print(f" [-] Skipping {sha256[:10]} (Type: {f_type} is not exe/dll)")
                continue
            # Fetch file
            file_res = requests.post("https://mb-api.abuse.ch/api/v1/",
                                     data={'query': 'get_file', 'sha256_hash': sha256},
                                     headers=headers)
            if file_res.content.startswith(b'PK'):
                try:
                    with pyzipper.AESZipFile(io.BytesIO(file_res.content), mode='r') as z:
                        z.extractall(path=family_dir, pwd=b'infected')
                    total_downloaded += 1
                    print(f" [OK] Saved: {sha256[:10]}... (Total: {total_downloaded})")
                    time.sleep(1)
                except Exception as e:
                    print(f" [!] Extraction Error: {e}")
            else:
                try:
                    error_data = file_res.json()
                    print(f" [!] Download Refused: {error_data.get('query_status')}")
                except:
                    print(f" [!] Download Refused: {file_res.text[:40]}")

    print(f"\n[FINISH] Total Authentics: {total_downloaded}")

if __name__ == "__main__":
    download_dataset()