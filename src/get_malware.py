import os, time, io, zipfile, requests
from dotenv import load_dotenv

load_dotenv()

# --- CONFIG ---
API_KEY =   os.environ.get("MALWARE_BAZAAR_API_KEY")
BASE_DIR = "data/malicious/authentic"
TARGET_TOTAL = 600
SAMPLES_PER_FAMILY = 50 

# Mix of tags; using both cases for maximum coverage
FAMILIES = ["lockbit", "LockBit", "conti", "wannacry", "Petya", "revil", "ryuk", "BlackMatter"]

def download_dataset():
    headers = {'Auth-Key': API_KEY.strip()}
    total_downloaded = 0
    os.makedirs(BASE_DIR, exist_ok=True)

    for tag in FAMILIES:
        if total_downloaded >= TARGET_TOTAL: break
        
        family_dir = os.path.join(BASE_DIR, tag)
        os.makedirs(family_dir, exist_ok=True)
        print(f"\n[*] Querying family: {tag}")
        
        # 1. Search (Query status 'ok' is what we just verified)
        payload = {'query': 'get_taginfo', 'tag': tag, 'limit': 50}
        res = requests.post("https://mb-api.abuse.ch/api/v1/", data=payload, headers=headers)
        
        data = res.json()
        if data.get('query_status') != 'ok':
            print(f"[-] No files for {tag} (Reason: {data.get('query_status')})")
            continue

        # 2. Download loop
        for sample in data.get('data', []):
            if total_downloaded >= TARGET_TOTAL: break
            sha256 = sample['sha256_hash']
            if sample.get('file_type') not in ['exe', 'dll']: continue
            
            # Request file
            file_res = requests.post("https://mb-api.abuse.ch/api/v1/", 
                                     data={'query': 'get_file', 'sha256_hash': sha256}, 
                                     headers=headers)

            if file_res.content.startswith(b'PK'): # Verify ZIP signature
                try:
                    with zipfile.ZipFile(io.BytesIO(file_res.content)) as z:
                        z.extractall(path=family_dir, pwd=b'infected')
                    total_downloaded += 1
                    print(f"    [+] Saved: {sha256[:10]}... ({total_downloaded}/{TARGET_TOTAL})")
                    time.sleep(1) # Rate limit safety
                except: continue
            else:
                print(f"    [-] Quota/Error for {sha256[:10]}: {file_res.text[:30]}")
                if "daily_limit_exceeded" in file_res.text: return

    print(f"\n[FINISH] Dataset ready in {BASE_DIR}")

if __name__ == "__main__":
    download_dataset()